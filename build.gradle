buildscript {
    repositories {
        mavenCentral()
    }
}

plugins {
    id "org.jetbrains.intellij" version "0.2.11"
    id "de.undercouch.download" version "3.2.0"
}

configurations {
    runtime.exclude group: 'com.jetbrains', module: 'php'
}

sourceCompatibility = javaVersion
targetCompatibility = javaTargetVersion

apply plugin: 'idea'
apply plugin: 'org.jetbrains.intellij'
apply plugin: 'java'

intellij {
    version 'IU-2017.1.4'
    pluginName 'TYPO3 CMS Plugin'

    plugins = ['CSS', 'yaml']

    sandboxDirectory = project.rootDir.canonicalPath + "/.sandbox"

    publishPlugin {
        username "$JETBRAINS_USERNAME"
        password "$JETBRAINS_PASSWORD"
    }
}

dependencies {
    compile fileTree(dir: 'libs', include: ['**/*.jar'])
}

group 'com.cedricziel.idea'
version '0.1.12' // Plugin version

task downloadPhpPlugin {
    def destFile = "${rootDir}/cache/php-plugin-${phpPluginVersion}.zip"
    download {
        src "https://download.plugins.jetbrains.com/6610/35779/php-${phpPluginVersion}.zip"
        dest destFile
        overwrite false
    }

    copy {
        from zipTree(destFile)
        into "${rootDir}/cache/"
        include 'php/lib/php.jar', 'php/lib/php-openapi.jar'
    }

    copy {
        from "${rootDir}/cache/php/lib/php.jar", "${rootDir}/cache/php/lib/php-openapi.jar"
        into 'libs/'
    }

    copy {
        from "${rootDir}/cache/php/lib/php.jar", "${rootDir}/cache/php/lib/php-openapi.jar"
        into '.sandbox/config/plugins/php/lib/'
    }
}

compileJava.dependsOn downloadPhpPlugin
